# ============================================================
# Environment Presets (loaded via 1Password)
# Usage: use_env <preset-name>
# ============================================================

# Vault configuration
OP_VAULT="Dev"
OP_ITEM="APIKeys"

# Available presets (section names in 1Password)
ENV_PRESETS=(wukong192 wukong152 myglm)

# Load environment preset from 1Password
use_env() {
    local preset="$1"

    if [[ -z "$preset" ]]; then
        echo "Available presets: ${ENV_PRESETS[*]}"
        echo "Usage: use_env <preset-name>"
        return 1
    fi

    # Check if signed in
    if ! op whoami &>/dev/null; then
        echo "Signing in to 1Password..."
        eval $(op signin)
    fi

    echo "Loading preset: $preset"

    # Load all fields from the section
    export ANTHROPIC_BASE_URL=$(op read "op://${OP_VAULT}/${OP_ITEM}/${preset}/ANTHROPIC_BASE_URL" 2>/dev/null)
    export ANTHROPIC_AUTH_TOKEN=$(op read "op://${OP_VAULT}/${OP_ITEM}/${preset}/ANTHROPIC_AUTH_TOKEN" 2>/dev/null)

    if [[ -n "$ANTHROPIC_BASE_URL" ]]; then
        echo "ANTHROPIC_BASE_URL=$ANTHROPIC_BASE_URL"
        echo "ANTHROPIC_AUTH_TOKEN=****${ANTHROPIC_AUTH_TOKEN: -4}"
        echo "Preset '$preset' loaded!"
    else
        echo "Error: Failed to load preset '$preset'"
        return 1
    fi
}

# Load GitLab credentials
load_gitlab() {
    if ! op whoami &>/dev/null; then
        echo "Signing in to 1Password..."
        eval $(op signin)
    fi

    export GITLAB_TOKEN=$(op read "op://${OP_VAULT}/${OP_ITEM}/gitlab/GITLAB_TOKEN" 2>/dev/null)
    export GITLAB_HOST=$(op read "op://${OP_VAULT}/${OP_ITEM}/gitlab/GITLAB_HOST" 2>/dev/null)

    if [[ -n "$GITLAB_TOKEN" ]]; then
        echo "GITLAB_HOST=$GITLAB_HOST"
        echo "GITLAB_TOKEN=****${GITLAB_TOKEN: -4}"
        echo "GitLab credentials loaded!"
    else
        echo "Error: Failed to load GitLab credentials"
        return 1
    fi
}

# Clear environment preset
clear_env() {
    unset ANTHROPIC_BASE_URL
    unset ANTHROPIC_AUTH_TOKEN
    unset GITLAB_TOKEN
    unset GITLAB_HOST
    echo "Environment cleared!"
}

# Show current environment
show_env() {
    echo "=== Anthropic ==="
    echo "ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-<not set>}"
    if [[ -n "$ANTHROPIC_AUTH_TOKEN" ]]; then
        echo "ANTHROPIC_AUTH_TOKEN=****${ANTHROPIC_AUTH_TOKEN: -4}"
    else
        echo "ANTHROPIC_AUTH_TOKEN=<not set>"
    fi
    echo ""
    echo "=== GitLab ==="
    echo "GITLAB_HOST=${GITLAB_HOST:-<not set>}"
    if [[ -n "$GITLAB_TOKEN" ]]; then
        echo "GITLAB_TOKEN=****${GITLAB_TOKEN: -4}"
    else
        echo "GITLAB_TOKEN=<not set>"
    fi
}
